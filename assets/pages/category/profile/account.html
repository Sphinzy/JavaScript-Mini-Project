<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile | User Account</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />

    <style>
      :root {
        --glass: rgba(255, 255, 255, 0.15);
        --glass-border: rgba(255, 255, 255, 0.2);
        --accent: #00f2fe;
      }
      body {
        font-family: "Outfit", sans-serif;
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(45deg, #0f0c29, #302b63, #24243e);
        background-size: 400% 400%;
        animation: gradientBG 15s ease infinite;
      }
      @keyframes gradientBG {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }
      .profile-card {
        width: 100%;
        max-width: 400px;
        background: var(--glass);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 30px;
        padding: 40px 30px;
        text-align: center;
        color: white;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
      }
      .avatar-container {
        width: 130px;
        height: 130px;
        margin: 0 auto 25px;
      }
      .avatar-container img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid var(--accent);
        padding: 5px;
      }
      .info-box {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 12px;
        text-align: left;
        border-left: 3px solid var(--accent);
      }
      .label {
        font-size: 0.75rem;
        color: #aaa;
        text-transform: uppercase;
        margin-bottom: 4px;
      }
      .value {
        font-size: 0.95rem;
        font-weight: 400;
      }
      .btn-glow {
        background: linear-gradient(45deg, #00dbde 0%, #fc00ff 100%);
        border: none;
        color: white;
        padding: 15px;
        border-radius: 15px;
        font-weight: 600;
        width: 100%;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div class="profile-card">
      <div class="avatar-container">
        <img
          id="profile-img"
          src="https://via.placeholder.com/130"
          alt="Profile"
        />
      </div>

      <h2 class="user-name" id="display-name">Loading...</h2>
      <p class="text-info mb-4" style="font-size: 0.9rem; opacity: 0.8">
        Verified Member
      </p>

      <div class="info-box">
        <div class="label">First Name</div>
        <div id="first-name" class="value">...</div>
      </div>

      <div class="info-box">
        <div class="label">Last Name</div>
        <div id="last-name" class="value">...</div>
      </div>

      <div class="info-box">
        <div class="label">Email Address</div>
        <div id="email-address" class="value">...</div>
      </div>

      <button class="btn btn-glow" onclick="editProfile()">
        <i class="bi bi-gear-fill me-2"></i> EDIT SETTINGS
      </button>
    </div>

    <script>
      // ១. បង្កើត Fake Data ក្នុង LocalStorage សម្រាប់តេស្ត (ករណីដៃគូមិនទាន់បាន Push code)
      const MOCK_LOGIN_DATA = {
        firstName: "Barry",
        lastName: "Allen",
        email: "barry.allen@starlabs.com",
        avatar: "../../../img/avatar.png",
        token:
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOjEwMDEsImlhdCI6MTc2NjQ5NjM3MiwiZXhwIjoxNzY3MTAxMTcyfQ.a68ZQ0PMMhOejEXAGByEq2GsQiTB_h0NNtflclzT4Zg",
      };

      // ប្រសិនបើគ្មានទិន្នន័យក្នុង LocalStorage ទេ ឱ្យវាយក Mock Data ទៅដាក់សិន
      if (!localStorage.getItem("user_info")) {
        localStorage.setItem("user_info", JSON.stringify(MOCK_LOGIN_DATA));
      }

      // ២. កំណត់ URL របស់ API
      const API_URL = "http://blogs.csm.linkpc.net/api/v1/auth/me";

      async function fetchUserData() {
        // ទាញទិន្នន័យបឋមពី LocalStorage មកបង្ហាញសិន (កុំឱ្យ User ចាំ Loading យូរ)
        const storedData = JSON.parse(localStorage.getItem("user_info"));
        if (storedData) {
          updateUI(storedData);
        }

        try {
          console.log("Loading API...");
          const response = await fetch(API_URL, {
            method: "GET",
            headers: {
              Authorization: `Bearer ${storedData.token}`,
              Accept: "application/json",
              "Content-Type": "application/json",
            },
          });

          if (response.ok) {
            const result = await response.json();
            console.log("Successfully API:", result);

            // ឆែកមើល Structure របស់ API (តាម Postman របស់អ្នក)
            const user = result.data.user || result.data;
            updateUI(user);

            // Update LocalStorage ជាមួយទិន្នន័យថ្មីបំផុតពី API
            const updatedStorage = { ...user, token: storedData.token };
            localStorage.setItem("user_info", JSON.stringify(updatedStorage));
          } else {
            console.warn("API Error:", response.status);
          }
        } catch (error) {
          console.error("Fetch Error (API Wrong URL):", error);
        }
      }

      // Function សម្រាប់បោះទិន្នន័យចូល UI
      function updateUI(user) {
        document.getElementById("first-name").innerText =
          user.firstName || "N/A";
        document.getElementById("last-name").innerText = user.lastName || "N/A";
        document.getElementById("email-address").innerText =
          user.email || "N/A";
        document.getElementById("display-name").innerText = `${
          user.firstName || ""
        } ${user.lastName || ""}`;

        if (user.avatar) {
          document.getElementById("profile-img").src = user.avatar;
        }
      }

      function editProfile() {
        window.location.href = "upload_avata.html";
      }

      window.onload = fetchUserData;
    </script>
  </body>
</html>
