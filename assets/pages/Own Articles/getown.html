<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>My Articles</title>
    <link rel="stylesheet" href="../../css/style.css" />
    <link rel="stylesheet" href="../../css/theme.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../../bootstrap-5.3.7/css/bootstrap.css" />

    <style>
      body {
        background: #f5f6fb;
        font-family: Poppins, sans-serif;
      }
      .article-card {
        border-radius: 18px;
        border: none;
        transition: 0.3s;
        height: 100%;
        display: flex;
        flex-direction: column;
        background: white;
        overflow: hidden;
      }
      .article-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.08);
      }
      .article-thumb {
        height: 260px;
        object-fit: cover;
      }
      .badge-category {
        background: #ede7fb;
        color: #6f42c1;
        border-radius: 50px;
        padding: 6px 14px;
        font-size: 0.75rem;
        font-weight: 500;
      }

      .article-desc {
        color: #6c757d;
        font-size: 0.875rem;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        margin-top: 10px;
        min-height: 3.2em;
      }
      .action-btn {
        border-radius: 10px;
        font-weight: 500;
        font-size: 0.9rem;
      }
      .card-body {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }
    </style>
  </head>

  <body>
    <div class="container py-5">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold">My Published Articles</h3>
        <a
          href="create.html"
          class="btn btn-primary rounded-pill px-4"
          style="background: #7645bf; border: none"
          >+ New Article</a
        >
      </div>
      <div class="row g-4" id="articlesContainer"></div>
    </div>

    <div class="modal fade" id="deleteModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
          <div class="modal-header border-0">
            <h5 class="fw-bold text-danger">Confirm Delete</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body py-4">
            Are you sure you want to delete this article? This action cannot be
            undone.
          </div>
          <div class="modal-footer border-0">
            <button class="btn btn-light px-4" data-bs-dismiss="modal">
              Cancel
            </button>
            <button class="btn btn-danger px-4" id="confirmDeleteBtn">
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const baseUrl = "http://blogs.csm.linkpc.net/api/v1";
      const token =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOjEwMTgsImlhdCI6MTc2NjYzMDAyOSwiZXhwIjoxNzY3MjM0ODI5fQ.hEyenaeG6GtYrhbLCvHjAAZFeA6WM7YpIw3mqU6zwyY";
      let deleteId = null;

      function fetchArticles() {
        fetch(baseUrl + "/articles/own?_page=1&_per_page=20", {
          headers: { Authorization: "Bearer " + token },
        })
          .then((res) => res.json())
          .then((data) => {
            let html = "";
            data.data.items.forEach((a) => {
              html += `
              <div class="col-xl-4 col-lg-4 col-md-6">
                <div class="card article-card shadow-sm">
                  <img src="${
                    a.thumbnail || "https://via.placeholder.com/400x200"
                  }" class="article-thumb w-100">
                  <div class="card-body">
                    <div>
                      <span class="badge-category">${
                        a.category?.name || "Uncategorized"
                      }</span>
                      <small class="float-end text-muted">${new Date(
                        a.createdAt
                      ).toLocaleDateString("en-GB", {
                        day: "numeric",
                        month: "short",
                        year: "numeric",
                      })}</small>
                      <h5 class="mt-3 fw-bold text-dark text-truncate">${
                        a.title
                      }</h5>
                      <p class="article-desc">${getPlainText(
                        a.description || a.content
                      )}</p>
                    </div>
                    <div class="d-flex gap-2 mt-3">
                      <button class="btn btn-outline-primary w-50 action-btn" onclick="editArticle(${
                        a.id
                      })">
                        <i class="bi bi-pencil"></i> Edit
                      </button>
                      <button class="btn btn-outline-danger w-50 action-btn" onclick="deleteArticle(${
                        a.id
                      })">
                        <i class="bi bi-trash"></i> Delete
                      </button>
                    </div>
                  </div>
                </div>
              </div>`;
            });
            document.getElementById("articlesContainer").innerHTML = html;
          });
      }

    
      function getPlainText(content) {
        if (!content) return "No description provided.";
        try {
          const data = JSON.parse(content);
          if (data.ops) {
            return data.ops
              .map((op) => op.insert)
              .join("")
              .trim();
          }
        } catch (e) {
          return content; 
        }
        return content;
      }

      function editArticle(id) {
        location.href = "edit.html?id=" + id;
      }

      function deleteArticle(id) {
        deleteId = id;
        new bootstrap.Modal(document.getElementById("deleteModal")).show();
      }

      document.getElementById("confirmDeleteBtn").onclick = () => {
        fetch(baseUrl + "/articles/" + deleteId, {
          method: "DELETE",
          headers: { Authorization: "Bearer " + token },
        }).then((res) => {
          if (res.ok) {
            bootstrap.Modal.getInstance(
              document.getElementById("deleteModal")
            ).hide();
            fetchArticles();
          }
        });
      };

      fetchArticles();
    </script>
  </body>
</html>
