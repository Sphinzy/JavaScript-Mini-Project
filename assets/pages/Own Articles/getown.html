<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>My Articles</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../css/theme.css">
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../../bootstrap-5.3.7/css/bootstrap.css" />

    <style>
      body {
        background: #f5f6fb;
        font-family: Poppins, sans-serif;
      }
      .article-card {
        border-radius: 18px;
        border: none;
        transition: 0.3s;
        height: 100%;
        display: flex;
        flex-direction: column;
        background: white;
        overflow: hidden;
      }
      .article-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.08);
      }
      .article-thumb {
        height: 260px;
        object-fit: cover;
      }
      .badge-category {
        background: #ede7fb;
        color: #6f42c1;
        border-radius: 50px;
        padding: 6px 14px;
        font-size: 0.75rem;
        font-weight: 500;
      }

      .article-desc {
        color: #6c757d;
        font-size: 0.875rem;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        margin-top: 10px;
        min-height: 3.2em;
      }
      .action-btn {
        border-radius: 10px;
        font-weight: 500;
        font-size: 0.9rem;
      }
      .card-body {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }
    </style>
  </head>

  <body>
    <div class="container py-5">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h2 class="main-title mb-0">My Articles</h2>
          <small class="text-muted">Manage your content and publications</small>
        </div>
        <button class="btn btn-main" onclick="location.href='tcreate.html'">
          <i class="bi bi-plus-lg me-2"></i> Create Article
        </button>
      </div>

      <div class="card p-4">
        <div class="table-responsive">
          <table class="table align-middle">
            <thead class="text-secondary small">
              <tr>
                <th>IMAGE</th>
                <th>TITLE</th>
                <th>CATEGORY</th>
                <th>DATE</th>
                <th class="text-center">ACTIONS</th>
              </tr>
            </thead>
            <tbody id="articleTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      const baseUrl = "http://blogs.csm.linkpc.net/api/v1";
      //const token = localStorage.getItem("token");
      const token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOjEwMTgsImlhdCI6MTc2NjYzMDAyOSwiZXhwIjoxNzY3MjM0ODI5fQ.hEyenaeG6GtYrhbLCvHjAAZFeA6WM7YpIw3mqU6zwyY'

      function fetchArticles() {
        fetch(baseUrl + "/articles/own?_page=1&_per_page=20", {
          headers: { Authorization: "Bearer " + token },
        })
          .then((res) => res.json())
          .then((result) => {
            let articles = result.data.items;
            let list = "";

            articles.forEach((art) => {
              let thumb = art.thumbnail
                ? art.thumbnail
                : "https://via.placeholder.com/55x40?text=No+Img";

              let catName = art.category ? art.category.name : "Uncategorized";

              list += `
            <tr>
                <td><img src="${thumb}" class="thumbnail-img shadow-sm"></td>
                <td class="fw-bold text-dark">${art.title}</td>
                <td><span class="badge badge-category">${catName}</span></td>
                <td class="text-muted small">${new Date(
                  art.createdAt
                ).toLocaleDateString()}</td>
                <td class="text-center">
                    <i class="bi bi-pencil-square text-muted action-icon icon-edit mx-2"></i>
                    <i class="bi bi-trash text-muted action-icon icon-delete mx-2" onclick="deleteArticle(${
                      art.id
                    })"></i>
                </td>
            </tr>
          `;
            });
            document.getElementById("articlesContainer").innerHTML = html;
          });
      }

    
      function getPlainText(content) {
        if (!content) return "No description provided.";
        try {
          const data = JSON.parse(content);
          if (data.ops) {
            return data.ops
              .map((op) => op.insert)
              .join("")
              .trim();
          }
        } catch (e) {
          return content; 
        }
        return content;
      }

      function editArticle(id) {
        location.href = "edit.html?id=" + id;
      }
      //delete
      function deleteArticle(id) {
        if (confirm("Do you want to delete?")) {
          fetch(baseUrl + "/articles/" + id, {
            method: "DELETE",
            headers: {
              Authorization: "Bearer " + token,
            },
          }).then((res) => {
            if (res.ok) {
              alert("Deleted!");
              fetchMyArticles();
            }
          });
        }
      }

      fetchArticles();
    </script>
    <script>
      //const token = localStorage.getItem('token');
      const imageLink = localStorage.getItem('getImage');
      const getImage = document.querySelector('#profile-image');
      const btnLogout = document.querySelector('#btnLogout');
      btnLogout.addEventListener('click', () => {
        fetch(baseUrl + "/auth/logout", {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        })
          .then(res => res.json())
          .then(resData => {
            localStorage.removeItem('token');
            return location.href = '../login/login.html'
            console.log(resData);

          })
      })
      //getImage.setAttribute('src', imageLink);
      getImage.src = imageLink;
    </script>
    <script src="../../bootstrap-5.3.7/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
